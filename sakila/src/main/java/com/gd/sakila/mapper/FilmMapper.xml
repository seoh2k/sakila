<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gd.sakila.mapper.FilmMapper"> 

	<!-- 영화에 따른 배우 리스트 -->
	<select id="selectFilmActorListByFilm"
			parameterType="int"
			resultType="java.util.Map">
		SELECT 
			a.actor_id actorId, 
			CONCAT(first_name, ' ', last_name) name, 
			film_id filmId
		FROM actor a LEFT JOIN (SELECT *
								FROM film_actor
								WHERE film_id = #{filmId}) t
		ON a.actor_id = t.actor_id
		ORDER BY first_name ASC
	</select>
	
	<select id="selectFilmOne" parameterType="Integer" resultType="java.util.Map">
		SELECT 
			f.film_id filmId,
			f.title title,
			f.description description,
			f.release_year releaseYear,
			l.name language,
			f.original_language_id originalLanguageId,
			f.rental_duration rentalDuration,
			f.rental_rate rentalRate,
			f.length length,
			f.replacement_cost replacementCost,
			f.rating rating,
			f.special_features specialFeatures,
			f.last_update lastUpdate, 
			fl.actors actors,
			fl.category category
		FROM film f
		LEFT JOIN film_list fl ON f.film_id = fl.FID
		JOIN language l ON f.language_id = l.language_id
		WHERE
			FID = #{FID}
	</select>
	
	<select id="selectFilmList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT 
			FID,
			title,
			category,
			price,
			rating,
			actors
		FROM film_list
		<where> <!-- where 태그를 사용하도록 한다. where절 쓰지 않고 -->
			<if test="categoryName != null"> <!-- 자바식 코드 사용 -->
				AND category = #{categoryName} <!-- and나 or가 나올 수 있다. -->
			</if>
			<if test="price != null">
				AND price = #{price} 
			</if>
			<if test="title != null">
				AND title LIKE CONCAT('%', #{title}, '%')
			</if>
			<if test="rating != null">
				AND rating = #{rating}
			</if>
			<if test="actors != null">
				AND actors LIKE CONCAT('%',#{actors},'%') <!-- 널이 들어가면 안된다. 차라리 공백이 들어간다. -->
			</if>
		</where>
		ORDER BY FID ASC
		LIMIT #{beginRow}, #{rowPerPage}
	</select>
	
	<select id="selectFilmTotal" parameterType="java.util.Map" resultType="Integer">
		SELECT COUNT(*) FROM film_list
		<where>
			<if test="categoryName != null"> <!-- 자바식 코드 사용 -->
				AND category = #{categoryName} <!-- and나 or가 나올 수 있다. -->
			</if>
			<if test="price != null">
				AND price = #{price} 
			</if>
			<if test="title != null">
				AND title LIKE CONCAT('%', #{title}, '%')
			</if>
			<if test="rating != null">
				AND rating = #{rating}
			</if>
			<if test="actors != null">
				AND actors LIKE CONCAT('%',#{actors},'%') <!-- 널이 들어가면 안된다. 차라리 공백이 들어간다. -->
			</if>
		</where>
	</select>
	
	<!-- Map: filmId(in), storeId(in), filmCount(out) -->
	<select id="selectFilmInStock" 
		parameterType="java.util.Map"
		resultType="int"
		statementType="CALLABLE">
		{
			call film_in_stock(
				#{filmId},
				#{storeId},
				#{filmCount, mode=OUT, jdbcType=DECIMAL, javaType=Integer}
			)
		}
	</select>

</mapper>